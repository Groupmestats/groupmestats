#!/usr/bin/ruby
require 'rubygems'
require 'json'
require 'yaml'
require 'httparty'
require 'optparse'
require 'sqlite3'
require "highline/import"

class Configure_Scraper
    include HTTParty
    base_uri 'https://api.groupme.com/v3//'
    format :json
end

#This will create the users and messages tables.  Run this before running any other methods
def createTables(database_path)
    begin   
        database = SQLite3::Database.new( database_path )
    rescue
        abort('Invalid database file')
    end

    if database.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='groups';").empty?
        database.execute('CREATE TABLE groups(group_id INT, late_scraped DATETIME);')
    end

    if database.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='users';").empty?
        database.execute('CREATE TABLE users(Name TEXT, user_id INT PRIMARY KEY);')
    end
    
    if database.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='messages';").empty?
        database.execute('CREATE TABLE messages(message_id INT PRIMARY KEY, created_at DATETIME, user_id INT, group_id INT, avatar_url TEXT, text TEXT, image TEXT, FOREIGN KEY(user_id) REFERENCES users(user_id), FOREIGN KEY(group_id) REFERENCES groups(group_id));')
    end

    if database.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='likes';").empty?
        database.execute('CREATE TABLE likes(message_id INT, user_id INT, FOREIGN KEY(message_id) REFERENCES messages(message_id), FOREIGN KEY(user_id) REFERENCES users(user_id))' )
    end
end

def writeConfig(file_path, token, database_path, group_name)
    groups = Configure_Scraper.get("groups?token=#{token}", :verify => false)

    if groups.code != 200
        abort('Invalid token')
    end

    group_id = ''   
    groups['response'].each do |group|
        if group['name'] == (group_name)
            group_id = group['id']
        end
    end
    if group_id.empty?
        abort("Cannot find group: #{group_name}")
    end
    config_file = File.open(file_path, 'w')
    config_file.write("---
groupme:
   api: https://api.groupme.com/v3//
   token: #{token}
   database: #{database_path}
   group_id: #{group_id}
")
end

puts 'Welcome to the Groupme scraper installer.  Before you continue, make sure you have ruby and SQLite3 installed, and have run the Bundler.'

file_path = '/etc/groupme.yaml'
input = ask 'Enter the full path for the config file[Default: /etc/groupme.yaml]:'

if !input.empty?
    file_path = input
end

database = ask 'Enter the full path for the database:'
token = ask 'Enter your Groupme oauth token (See: https://dev.groupme.com/tutorials/oauth)'
group = ask 'Enter the name of the group you want to scrap data from'
writeConfig(file_path, token, database, group)

puts "Creating the users and messages tables in the database"
createTables(database)
